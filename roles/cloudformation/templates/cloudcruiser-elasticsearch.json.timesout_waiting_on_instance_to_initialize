{
    "Mappings": {
        "AWSInstanceType2Arch": {
            "c1.medium": {
                "Arch": "PV64"
            },
            "c1.xlarge": {
                "Arch": "PV64"
            },
            "c3.2xlarge": {
                "Arch": "HVM64"
            },
            "c3.4xlarge": {
                "Arch": "HVM64"
            },
            "c3.8xlarge": {
                "Arch": "HVM64"
            },
            "c3.large": {
                "Arch": "HVM64"
            },
            "c3.xlarge": {
                "Arch": "HVM64"
            },
            "cc2.8xlarge": {
                "Arch": "HVM64"
            },
            "cr1.8xlarge": {
                "Arch": "HVM64"
            },
            "hi1.4xlarge": {
                "Arch": "HVM64"
            },
            "hs1.8xlarge": {
                "Arch": "HVM64"
            },
            "i2.2xlarge": {
                "Arch": "HVM64"
            },
            "i2.4xlarge": {
                "Arch": "HVM64"
            },
            "i2.8xlarge": {
                "Arch": "HVM64"
            },
            "i2.xlarge": {
                "Arch": "HVM64"
            },
            "m1.large": {
                "Arch": "PV64"
            },
            "m1.medium": {
                "Arch": "PV64"
            },
            "m1.small": {
                "Arch": "PV64"
            },
            "m1.xlarge": {
                "Arch": "PV64"
            },
            "m2.2xlarge": {
                "Arch": "PV64"
            },
            "m2.4xlarge": {
                "Arch": "PV64"
            },
            "m2.xlarge": {
                "Arch": "PV64"
            },
            "m3.2xlarge": {
                "Arch": "HVM64"
            },
            "m3.large": {
                "Arch": "HVM64"
            },
            "m3.medium": {
                "Arch": "HVM64"
            },
            "m3.xlarge": {
                "Arch": "HVM64"
            },
            "r3.2xlarge": {
                "Arch": "HVM64"
            },
            "r3.4xlarge": {
                "Arch": "HVM64"
            },
            "r3.8xlarge": {
                "Arch": "HVM64"
            },
            "r3.large": {
                "Arch": "HVM64"
            },
            "r3.xlarge": {
                "Arch": "HVM64"
            },
            "t1.micro": {
                "Arch": "PV64"
            },
            "t2.medium": {
                "Arch": "HVM64"
            },
            "t2.micro": {
                "Arch": "HVM64"
            },
            "t2.small": {
                "Arch": "HVM64"
            }
        },
        "AWSRegionArch2AMI": {
            "ap-northeast-1": {
                "HVM64": "ami-18869819",
                "PV64": "ami-3c87993d"
            },
            "ap-southeast-1": {
                "HVM64": "ami-d50773ef",
                "PV64": "ami-1500742f"
            },
            "cn-north-1": {
                "HVM64": "ami-981d8fa1",
                "PV64": "ami-8a1d8fb3"
            },
            "eu-central-1": {
                "HVM64": "ami-04003319",
                "PV64": "ami-0600331b"
            },
            "eu-west-1": {
                "HVM64": "ami-9d23aeea",
                "PV64": "ami-7b3db00c"
            },
            "sa-east-1": {
                "HVM64": "ami-af9925b2",
                "PV64": "ami-fd9925e0"
            },
            "us-east-1": {
                "HVM64": "ami-146e2a7c",
                "PV64": "ami-8e682ce6"
            },
            "us-west-1": {
                "HVM64": "ami-42908907",
                "PV64": "ami-f49089b1"
            },
            "us-west-2": {
                "HVM64": "ami-dfc39aef",
                "PV64": "ami-9fc29baf"
            }
        },
        "ElasticsearchVersion2AWSCloudPluginVersion": {
            "1.4.2": {
                "Ver": "2.4.1"
            }
        },
        "ElasticsearchVersion2ServiceWrapperHash": {
            "1.4.2": {
                "Hash": "4943d5a"
            }
        }
    },
    "Parameters": {
        "AvailabilityZone1": {
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Can contain only ASCII characters.",
            "Description": "The first of two AZs",
            "MaxLength": "255",
            "MinLength": "1",
            "Type": "String"
        },
        "AvailabilityZone2": {
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Can contain only ASCII characters.",
            "Description": "The second of two AZs",
            "MaxLength": "255",
            "MinLength": "1",
            "Type": "String"
        },
        "ClusterSize": {
            "Default": "1",
            "Description": "The size of the elasticsearch cluster",
            "Type": "Number"
        },
        "ElasticsearchVersion": {
            "AllowedValues": [
                "1.4.2"
            ],
            "ConstraintDescription": "Must be a supported version number.",
            "Default": "1.4.2",
            "Description": "The version of elasticsearch to deploy",
            "Type": "String"
        },
        "InstanceType": {
            "AllowedValues": [
                "t1.micro",
                "m1.small",
                "m1.medium",
                "m1.large",
                "m1.xlarge",
                "m2.xlarge",
                "m2.2xlarge",
                "m2.4xlarge",
                "m3.xlarge",
                "m3.2xlarge",
                "c1.medium",
                "c1.xlarge",
                "cc1.4xlarge",
                "cc2.8xlarge",
                "cg1.4xlarge"
            ],
            "ConstraintDescription": "must be a valid EC2 instance type.",
            "Default": "m1.small",
            "Description": "Elasticsearch EC2 instance type",
            "Type": "String"
        },
        "KeyPairName": {
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Can contain only ASCII characters.",
            "Description": "Name of an existing EC2 KeyPair to enable SSH access to the service instances",
            "MaxLength": "255",
            "MinLength": "1",
            "Type": "String"
        },
        "ServiceSubnet1": {
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Can contain only ASCII characters.",
            "Description": "Subnet1 for the elasticsearch cluster",
            "MaxLength": "255",
            "MinLength": "1",
            "Type": "String"
        },
        "ServiceSubnet2": {
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Can contain only ASCII characters.",
            "Description": "Subnet2 for the elasticsearch cluster",
            "MaxLength": "255",
            "MinLength": "1",
            "Type": "String"
        },
        "VPC": {
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Can contain only ASCII characters.",
            "Description": "VPC where the services are being provisioned",
            "MaxLength": "255",
            "MinLength": "1",
            "Type": "String"
        }
    },
    "Resources": {
        "ElasticSearchServer": {
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "config": {
                        "commands": {
                            "createfile": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "echo \"",
                                            "cloud.aws.region:\n",
                                            " ",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n",
                                            "discovery:\n",
                                            " type: ec2\n",
                                            "\n",
                                            "discovery.ec2.groups: ",
                                            {
                                                "Ref": "ElasticsearchSecurityGroup"
                                            },
                                            "\n",
                                            "discovery.ec2.tag.type: elasticsearch\n",
                                            "\n",
                                            "cloud.node.auto_attributes: true\n",
                                            " \" > ",
                                            "/usr/local/elasticsearch/elasticsearch-",
                                            {
                                                "Ref": "ElasticsearchVersion"
                                            },
                                            "/config/elasticsearch.yml"
                                        ]
                                    ]
                                }
                            }
                        }
                    }
                }
            },
            "Properties": {
                "AssociatePublicIpAddress": "true",
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda",
                        "Ebs": {
                            "DeleteOnTermination": "true",
                            "VolumeSize": "50"
                        }
                    }
                ],
                "IamInstanceProfile": {
                    "Ref": "ElasticsearchInstanceProfile"
                },
                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSRegionArch2AMI",
                        {
                            "Ref": "AWS::Region"
                        },
                        {
                            "Fn::FindInMap": [
                                "AWSInstanceType2Arch",
                                {
                                    "Ref": "InstanceType"
                                },
                                "Arch"
                            ]
                        }
                    ]
                },
                "InstanceType": {
                    "Ref": "InstanceType"
                },
                "KeyName": {
                    "Ref": "KeyPairName"
                },
                "SecurityGroups": [
                    {
                        "Ref": "ElasticsearchSecurityGroup"
                    }
                ]
            },
            "Type": "AWS::AutoScaling::LaunchConfiguration"
        },
        "ElasticsearchASG": {
            "CreationPolicy": {
                "ResourceSignal": {
                    "Count": 1,
                    "Timeout": "PT5M"
                }
            },
            "Properties": {
                "AvailabilityZones": [
                    {
                        "Ref": "AvailabilityZone1"
                    }
                ],
                "DesiredCapacity": {
                    "Ref": "ClusterSize"
                },
                "LaunchConfigurationName": {
                    "Ref": "ElasticSearchServer"
                },
                "MaxSize": "1",
                "MinSize": "1",
                "Tags": [
                    {
                        "Key": "type",
                        "PropagateAtLaunch": "false",
                        "Value": "elasticsearch"
                    }
                ],
                "VPCZoneIdentifier": [
                    {
                        "Ref": "ServiceSubnet1"
                    }
                ]
            },
            "Type": "AWS::AutoScaling::AutoScalingGroup"
        },
        "ElasticsearchDiscoveryRole": {
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            }
                        }
                    ]
                },
                "Path": "/"
            },
            "Type": "AWS::IAM::Role"
        },
        "ElasticsearchInstanceProfile": {
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "ElasticsearchDiscoveryRole"
                    }
                ]
            },
            "Type": "AWS::IAM::InstanceProfile"
        },
        "ElasticsearchRolePolicies": {
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "ec2:*"
                            ],
                            "Effect": "Allow",
                            "Resource": "*"
                        }
                    ]
                },
                "PolicyName": "esdiscovery",
                "Roles": [
                    {
                        "Ref": "ElasticsearchDiscoveryRole"
                    }
                ]
            },
            "Type": "AWS::IAM::Policy"
        },
        "ElasticsearchSecurityGroup": {
            "Properties": {
                "GroupDescription": "Security group used for the elasticsearch cluster",
                "SecurityGroupIngress": [
                    {
                        "CidrIp": "0.0.0.0/0",
                        "FromPort": "9200",
                        "IpProtocol": "tcp",
                        "ToPort": "9200"
                    },
                    {
                        "CidrIp": "0.0.0.0/0",
                        "FromPort": "9300",
                        "IpProtocol": "tcp",
                        "ToPort": "9300"
                    },
                    {
                        "CidrIp": "0.0.0.0/0",
                        "FromPort": "22",
                        "IpProtocol": "tcp",
                        "ToPort": "22"
                    }
                ],
                "VpcId": {
                    "Ref": "VPC"
                }
            },
            "Type": "AWS::EC2::SecurityGroup"
        }
    }
}